import React, { useState, useEffect } from 'react';
import { BrowserRouter as Router, Routes, Route, useLocation, Navigate } from 'react-router-dom';
import { onAuthStateChanged, GoogleAuthProvider, signInWithCredential, updateProfile } from 'firebase/auth';
import { auth, db } from './firebase';
import { doc, getDoc, setDoc, updateDoc } from 'firebase/firestore';
import { Capacitor } from '@capacitor/core';
import { App as CapacitorApp } from '@capacitor/app';
import { StatusBar, Style } from '@capacitor/status-bar';
import { Keyboard } from '@capacitor/keyboard';
import { PushNotifications } from '@capacitor/push-notifications';

// ÌéòÏù¥ÏßÄ Î∞è Ïª¥Ìè¨ÎÑåÌä∏ ÏûÑÌè¨Ìä∏ ÏÉùÎûµ (Í∏∞Ï°¥ Í∑∏ÎåÄÎ°ú)
import Home from './pages/Home';
import WriteDiary from './pages/diary/WriteDiary';
import Diary from './pages/diary/Diary';
import NovelList from './pages/novel/NovelList';
import DiaryView from './pages/diary/DiaryView';
import Novel from './pages/novel/Novel';
import Navigation from './components/Navigation';
import MyPage from './pages/mypage/MyPage';
import NovelCreate from './pages/novel/NovelCreate';
import NovelView from './pages/novel/NovelView';
import Login from './pages/Login';
import Signup from './pages/Signup';
import NovelListByGenre from './pages/novel/NovelListByGenre';
import { ToastProvider } from './components/ui/ToastProvider';
import Statistics from './pages/mypage/Statistics';
import Settings from './pages/mypage/Settings';
import NotificationSettings from './pages/mypage/NotificationSettings';
import Notice from './pages/mypage/Notice';
import Support from './pages/mypage/Support';
import Social from './pages/mypage/Social';
import Friend from './pages/mypage/Friend';
import Shop from './pages/mypage/Shop';
import NoticeDetail from './pages/mypage/NoticeDetail';
import ThemeSettings from './pages/mypage/ThemeSettings';
import { ThemeProvider, useTheme } from './ThemeContext';
import { ThemeProvider as StyledThemeProvider } from 'styled-components';
import { lightTheme, darkTheme } from './theme';
import { useNotification } from './hooks/useNotification';
import NotificationToast from './components/NotificationToast';
import PointHistory from './pages/mypage/PointHistory';
import PotionShop from './pages/mypage/PotionShop';
import PointCharge from './pages/mypage/PointCharge';
import UserManagement from './pages/admin/UserManagement';
import ProfileFix from './pages/mypage/ProfileFix';
import './utils/runPointUpdate'; // Ìè¨Ïù∏Ìä∏ ÏùºÍ¥Ñ ÏßÄÍ∏â Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú
import './utils/syncAuthUsers'; // ÏÇ¨Ïö©Ïûê ÎèôÍ∏∞Ìôî Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú
import './utils/debugUsers'; // ÏÇ¨Ïö©Ïûê ÎîîÎ≤ÑÍπÖ Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú
import './utils/adminAuth'; // Í¥ÄÎ¶¨Ïûê Í∂åÌïú Ï≤¥ÌÅ¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú
import './utils/updateGoogleProfileImages'; // Íµ¨Í∏Ä ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏ Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú
import './utils/fixGoogleProfiles'; // Íµ¨Í∏Ä ÌîÑÎ°úÌïÑ Î¨∏Ï†ú Ìï¥Í≤∞ Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú
import './utils/runPotionHistoryCleanup'; // Ìè¨ÏÖò ÏÇ¨Ïö© ÎÇ¥Ïó≠ Ï†ïÎ¶¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú
import FriendNovelList from './pages/novel/FriendNovelList';
import AppInfo from './pages/mypage/AppInfo';

const AppLayout = ({ user, isLoading }) => {
    const location = useLocation();
    const showNavigation = !['/login', '/signup'].includes(location.pathname);
    const { notification, hideNotification } = useNotification(user);

    if (isLoading) return <div>Î°úÎî© Ï§ë...</div>;

    return (
        <div className="App">
            <NotificationToast notification={notification} onClose={hideNotification} />
            <Routes>
                <Route path="/login" element={!user ? <Login /> : <Navigate to="/" />} />
                <Route path="/signup" element={!user ? <Signup /> : <Navigate to="/" />} />
                <Route path="/" element={user ? <Home user={user} /> : <Navigate to="/login" />} />
                <Route path="/home" element={user ? <Home user={user} /> : <Navigate to="/login" />} />
                <Route path="/write" element={user ? <WriteDiary user={user} /> : <Navigate to="/login" />} />
                <Route path="/write/:date" element={user ? <WriteDiary user={user} /> : <Navigate to="/login" />} />
                <Route path="/diaries" element={user ? <Diary user={user} /> : <Navigate to="/login" />} />
                <Route path="/novels" element={user ? <NovelList user={user} /> : <Navigate to="/login" />} />
                <Route path="/diary/date/:date" element={user ? <DiaryView user={user} /> : <Navigate to="/login" />} />
                <Route path="/novel" element={user ? <Novel user={user} /> : <Navigate to="/login" />} />
                <Route path="/my" element={user ? <MyPage user={user} /> : <Navigate to="/login" />} />
                <Route path="/novel/create" element={user ? <NovelCreate user={user} /> : <Navigate to="/login" />} />
                <Route path="/novel/:id" element={user ? <NovelView user={user} /> : <Navigate to="/login" />} />
                <Route path="/novels/genre/:genre" element={user ? <NovelListByGenre user={user} /> : <Navigate to="/login" />} />
                <Route path="/my/statistics" element={user ? <Statistics user={user} /> : <Navigate to="/login" />} />
                <Route path="/my/app-info" element={user ? <AppInfo user={user} /> : <Navigate to="/login" />} />
                <Route path="/my/settings" element={user ? <Settings user={user} /> : <Navigate to="/login" />} />
                <Route path="/my/notification-settings" element={user ? <NotificationSettings user={user} /> : <Navigate to="/login" />} />
                <Route path="/my/notice" element={user ? <Notice user={user} /> : <Navigate to="/login" />} />
                <Route path="/my/notice/:id" element={user ? <NoticeDetail user={user} /> : <Navigate to="/login" />} />
                <Route path="/my/support" element={user ? <Support user={user} /> : <Navigate to="/login" />} />
                <Route path="/my/social" element={user ? <Social user={user} /> : <Navigate to="/login" />} />
                <Route path="/my/friend" element={user ? <Friend user={user} /> : <Navigate to="/login" />} />
                <Route path="/my/shop" element={user ? <Shop user={user} /> : <Navigate to="/login" />} />
                <Route path="/my/shop/charge" element={user ? <PointCharge user={user} /> : <Navigate to="/login" />} />
                <Route path="/my/theme-settings" element={user ? <ThemeSettings user={user} /> : <Navigate to="/login" />} />
                <Route path="/my/point-history" element={<PointHistory user={user} />} />
                <Route path="/my/potion-shop" element={user ? <PotionShop user={user} /> : <Navigate to="/login" />} />
                <Route path="/my/profile-fix" element={user ? <ProfileFix user={user} /> : <Navigate to="/login" />} />
                <Route path="/friend-novels" element={user ? <FriendNovelList user={user} /> : <Navigate to="/login" />} />
                <Route path="/admin/users" element={user ? <UserManagement user={user} /> : <Navigate to="/login" />} />
            </Routes>
            {showNavigation && user && <Navigation user={user} />}
        </div>
    );
};

function App() {
    const [user, setUser] = useState(null);
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, (user) => {
            setUser(user);
            setIsLoading(false);
        });

        // üîê Îî•ÎßÅÌÅ¨ Î¶¨ÎîîÎ†âÏÖò Ï≤òÎ¶¨
        CapacitorApp.addListener('appUrlOpen', async ({ url }) => {
            if (url.startsWith('storypotion://auth')) {
                const hash = url.split('#')[1];
                const params = new URLSearchParams(hash);
                const idToken = params.get('id_token');

                if (idToken) {
                    try {
                        const credential = GoogleAuthProvider.credential(idToken);
                        const result = await signInWithCredential(auth, credential);
                        
                        // Íµ¨Í∏Ä Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ ÌõÑ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï≤òÎ¶¨
                        const user = result.user;
                        const userRef = doc(db, 'users', user.uid);
                        const userSnap = await getDoc(userRef);
                        
                        if (!userSnap.exists()) {
                            // Íµ¨Í∏Ä ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥ ÏÇ¨Ïö© (displayNameÍ≥º photoURL Î™®Îëê Íµ¨Í∏ÄÏóêÏÑú Í∞ÄÏ†∏Ïò® Í∞í ÏÇ¨Ïö©)
                            const googleDisplayName = user.displayName || user.email?.split('@')[0] || 'ÏÇ¨Ïö©Ïûê';
                            const googlePhotoURL = user.photoURL || `https://lh3.googleusercontent.com/a/${user.uid}=s96-c`;
                            
                            // Firebase AuthÏùò ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ (Íµ¨Í∏Ä Ï†ïÎ≥¥ Ïú†ÏßÄ)
                            await updateProfile(user, {
                                displayName: googleDisplayName,
                                photoURL: googlePhotoURL
                            });
                            
                            await setDoc(userRef, {
                                email: user.email || '',
                                displayName: googleDisplayName,
                                photoURL: googlePhotoURL,
                                point: 0,
                                createdAt: new Date(),
                                authProvider: 'google.com',
                                emailVerified: user.emailVerified || false,
                                isActive: true,
                                lastLoginAt: new Date(),
                                updatedAt: new Date()
                            });
                        } else {
                            const userData = userSnap.data();
                            if (userData.status === 'Ï†ïÏßÄ') {
                                console.error('‚ùå Ï†ïÏßÄÎêú Í≥ÑÏ†ïÏûÖÎãàÎã§.');
                                await auth.signOut();
                                return;
                            }
                            
                            // Í∏∞Ï°¥ ÏÇ¨Ïö©ÏûêÏùò Í≤ΩÏö∞ Íµ¨Í∏Ä ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥Î°ú ÏóÖÎç∞Ïù¥Ìä∏ (photoURLÏù¥ ÎπÑÏñ¥ÏûàÍ±∞ÎÇò Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄÏù∏ Í≤ΩÏö∞)
                            if (!userData.photoURL || userData.photoURL === process.env.PUBLIC_URL + '/default-profile.svg') {
                                const googlePhotoURL = user.photoURL || `https://lh3.googleusercontent.com/a/${user.uid}=s96-c`;
                                await updateDoc(userRef, {
                                    photoURL: googlePhotoURL,
                                    authProvider: 'google.com',
                                    lastLoginAt: new Date(),
                                    updatedAt: new Date()
                                });
                                
                                // Firebase AuthÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                                await updateProfile(user, {
                                    photoURL: googlePhotoURL
                                });
                            }
                        }
                        
                        console.log('‚úÖ Firebase Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ');
                    } catch (error) {
                        console.error('‚ùå Firebase Î°úÍ∑∏Ïù∏ Ïã§Ìå®:', error);
                    }
                }
            }
        });

        // Îí§Î°úÍ∞ÄÍ∏∞ Î≤ÑÌäº Ï≤òÎ¶¨ (Î™®Î∞îÏùº ÌôòÍ≤ΩÏóêÏÑúÎßå)
        if (Capacitor.getPlatform() !== 'web') {
            const backButtonListener = CapacitorApp.addListener('backButton', ({ canGoBack }) => {
                // ÌòÑÏû¨ Í≤ΩÎ°ú ÌôïÏù∏
                const currentPath = window.location.pathname;
                
                // Ìôà ÌôîÎ©¥ÏóêÏÑú Îí§Î°úÍ∞ÄÍ∏∞Î•º ÎàÑÎ•¥Î©¥ Ïï± Ï¢ÖÎ£å ÌôïÏù∏
                if (currentPath === '/' || currentPath === '/home') {
                    if (window.confirm('Ïï±ÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        CapacitorApp.exitApp();
                    }
                } else {
                    // Îã§Î•∏ ÌôîÎ©¥ÏóêÏÑúÎäî Í∏∞Î≥∏ Îí§Î°úÍ∞ÄÍ∏∞ ÎèôÏûë
                    window.history.back();
                }
            });

            // Ïª¥Ìè¨ÎÑåÌä∏ Ïñ∏ÎßàÏö¥Ìä∏ Ïãú Î¶¨Ïä§ÎÑà Ï†úÍ±∞
            return () => {
                unsubscribe();
                backButtonListener.remove();
            };
        }

        // FCM Ìë∏Ïãú ÏïåÎ¶º ÏàòÏã† Î¶¨Ïä§ÎÑà Îì±Î°ù (Î™®Î∞îÏùº ÌôòÍ≤ΩÏóêÏÑúÎßå)
        if (Capacitor.getPlatform() !== 'web') {
            PushNotifications.addListener('pushNotificationReceived', (notification) => {
                console.log('Ìë∏Ïãú ÏïåÎ¶º ÏàòÏã†:', notification);
                // TODO: ÌïÑÏöîÏãú Toast Îì±ÏúºÎ°ú ÌëúÏãú
                alert(notification.title + '\n' + notification.body);
            });
        }

        return () => unsubscribe();
    }, []);

    if (Capacitor.getPlatform() !== 'web') {
        StatusBar.setOverlaysWebView({ overlay: false });
        StatusBar.setStyle({ style: Style.Light });
        Keyboard.setScroll({ isDisabled: false });
        Keyboard.setResizeMode({ mode: 'body' });
    }

    return (
        <Router>
            <ThemeProvider>
                <ThemeConsumerWrapper>
                    <ToastProvider>
                        <AppLayout user={user} isLoading={isLoading} />
                    </ToastProvider>
                </ThemeConsumerWrapper>
            </ThemeProvider>
        </Router>
    );
}

function ThemeConsumerWrapper({ children }) {
    const { actualTheme } = useTheme();
    return (
        <StyledThemeProvider theme={actualTheme === 'dark' ? darkTheme : lightTheme}>
            {children}
        </StyledThemeProvider>
    );
}

export default App;
