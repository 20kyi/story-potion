# 구글 플레이 인앱결제 테스트 가이드

이 문서는 StoryPotion 앱에서 구글 플레이 인앱결제(정기 구독 및 일회성 결제)를 테스트하는 방법을 안내합니다.

## 목차
1. [필수 사전 준비](#필수-사전-준비)
2. [구글 플레이 콘솔 설정](#구글-플레이-콘솔-설정)
3. [인앱 상품 등록](#인앱-상품-등록)
4. [테스트 계정 설정](#테스트-계정-설정)
5. [앱 빌드 및 테스트](#앱-빌드-및-테스트)
6. [문제 해결](#문제-해결)

---

## 필수 사전 준비

### 1. 구글 플레이 콘솔 접근 권한
- Google Play Console에 앱이 이미 등록되어 있어야 합니다.
- 앱이 **내부 테스트 트랙** 이상으로 배포되어 있어야 합니다.
- (참고: 현재 앱 ID: `com.storypotion.app`)

### 2. 개발자 계정 설정
- Google Play Console에서 개발자 계정이 활성화되어 있어야 합니다.
- 결제 프로필이 설정되어 있어야 합니다.

---

## 구글 플레이 콘솔 설정

### 1. 인앱 상품 메뉴 접근
1. [Google Play Console](https://play.google.com/console)에 로그인합니다.
2. 앱을 선택합니다 (`StoryPotion`).
3. 왼쪽 메뉴에서 **수익 창출** > **인앱 제품** 또는 **구독**을 클릭합니다.

### 2. 라이선스 테스트 설정
인앱결제를 테스트하려면 테스트 계정을 설정해야 합니다:

1. **설정** > **라이선스 테스트**로 이동합니다.
2. **라이선스 테스트자** 섹션에서 테스트할 구글 계정 이메일을 추가합니다.
   - 예: `your-test-email@gmail.com`
   - 여러 계정 추가 가능 (각 계정당 한 줄씩)
3. **저장**을 클릭합니다.

⚠️ **중요**: 라이선스 테스트 계정으로 설정된 계정은 실제 결제 없이 인앱결제를 테스트할 수 있습니다.

---

## 인앱 상품 등록

### 일회성 상품 (In-App Products) 등록

앱에서 사용할 일회성 상품들을 등록합니다:

1. **수익 창출** > **인앱 제품** 메뉴로 이동합니다.
2. **인앱 제품 만들기** 버튼을 클릭합니다.
3. 각 상품 정보를 입력합니다:

#### 포인트 상품
| 제품 ID (언더스코어) | 구매 옵션 ID (하이픈) | 제품 이름 | 설명 | 가격 |
|---------------------|---------------------|----------|------|------|
| `points_100` | `points-100` | 포인트 100개 | 100포인트를 충전합니다 | ₩1,000 |
| `points_500` | `points-500` | 포인트 500개 | 500포인트를 충전합니다 (+50 보너스) | ₩5,000 |
| `points_1000` | `points-1000` | 포인트 1000개 | 1000포인트를 충전합니다 (+150 보너스) | ₩10,000 |
| `points_2000` | `points-2000` | 포인트 2000개 | 2000포인트를 충전합니다 (+400 보너스) | ₩20,000 |

#### 포션 상품
| 제품 ID (언더스코어) | 구매 옵션 ID (하이픈) | 제품 이름 | 설명 | 가격 |
|---------------------|---------------------|----------|------|------|
| `potion_romance` | `potion-romance` | 로맨스 포션 | 로맨스 장르 소설 생성 포션 | ₩1,000 |
| `potion_fantasy` | `potion-fantasy` | 판타지 포션 | 판타지 장르 소설 생성 포션 | ₩1,000 |
| `potion_mystery` | `potion-mystery` | 미스터리 포션 | 미스터리 장르 소설 생성 포션 | ₩1,000 |
| `potion_horror` | `potion-horror` | 호러 포션 | 호러 장르 소설 생성 포션 | ₩1,000 |
| `potion_historical` | `potion-historical` | 역사 포션 | 역사 장르 소설 생성 포션 | ₩1,000 |
| `potion_fairytale` | `potion-fairytale` | 동화 포션 | 동화 장르 소설 생성 포션 | ₩1,000 |
| `potion_set_6` | `potion-set-6` | 포션 6종 세트 | 모든 장르 포션 6종 세트 | ₩5,000 |

4. 각 상품에 대해:
   - **제품 ID**: 위 표의 제품 ID 사용 (정확히 일치해야 함)
   - **이름**: 한국어 이름
   - **설명**: 상품에 대한 설명
   - **가격**: 원하는 가격 설정
   - **활성화**: 체크하여 활성화

5. **저장**을 클릭합니다.

### 정기 구독 (Subscriptions) 등록

정기 구독 상품을 등록합니다:

1. **수익 창출** > **구독** 메뉴로 이동합니다.
2. **구독 만들기** 버튼을 클릭합니다.
3. 각 구독 정보를 입력합니다:

#### 구독 상품
| 제품 ID (언더스코어) | Base Plan ID (하이픈) | Offer ID (하이픈) | 제품 이름 | 설명 | 가격 | 구독 기간 |
|---------------------|---------------------|------------------|----------|------|------|----------|
| `premium_monthly` | `premium-monthly-base` | `premium-monthly-offer` | 월간 프리미엄 | 월간 프리미엄 구독 | ₩5,900 | 월간 |
| `premium_yearly` | `premium-yearly-base` | `premium-yearly-offer` | 연간 프리미엄 | 연간 프리미엄 구독 | ₩49,560 | 연간 |

4. 각 구독에 대해:
   - **제품 ID**: 위 표의 제품 ID 사용 (언더스코어 사용)
   - **Base Plan ID**: 위 표의 Base Plan ID 사용 (하이픈 사용)
   - **Offer ID**: 위 표의 Offer ID 사용 (하이픈 사용)
   - **이름**: 한국어 이름
   - **설명**: 구독 혜택 설명
   - **가격**: 원하는 가격 설정
   - **구독 기간**: 월간 또는 연간 선택
   - **무료 체험 기간**: **7일** 설정 (앱에서 구현된 무료 체험과 일치)
   - **활성화**: 체크하여 활성화

5. **저장**을 클릭합니다.

### 무료 체험 기간 설정

앱에서 **7일 무료 체험** 기능이 구현되어 있으므로, Google Play Console에서도 동일하게 설정하는 것을 권장합니다:

1. **Offer** 설정에서 **무료 체험** 섹션으로 이동
2. **무료 체험 기간**: `7일` 선택
3. 체험 기간 종료 후 자동으로 유료 구독으로 전환되도록 설정

⚠️ **중요**: 
- **무료 체험은 별도의 ID가 필요하지 않습니다!**
- 기존 Offer ID (`premium-monthly-offer`, `premium-yearly-offer`) 내에서 무료 체험 기간만 설정하면 됩니다.
- 같은 Offer ID를 사용하면서 무료 체험 옵션만 활성화하면 Google Play가 자동으로 관리합니다.

⚠️ **참고**: 
- 앱에서 자체적으로 무료 체험을 관리하는 기능도 있지만, Google Play Console에서 설정하면 Google Play가 자동으로 체험 기간을 관리합니다.
- 두 가지 방법을 모두 사용할 수 있지만, Google Play Console의 무료 체험을 사용하는 것이 더 안정적입니다.

⚠️ **주의**: 
- 제품 ID는 앱 코드의 `PRODUCT_IDS`와 정확히 일치해야 합니다.
- 상품을 활성화하면 변경 사항이 Google Play에 반영되는데 시간이 걸릴 수 있습니다 (몇 시간).

---

## 테스트 계정 설정

### 1. 테스트 계정 추가
1. Google Play Console에서 **설정** > **라이선스 테스트**로 이동합니다.
2. **라이선스 테스트자** 섹션에 테스트할 Google 계정 이메일을 추가합니다.
3. **저장**을 클릭합니다.

### 2. 테스트 기기에서 설정
1. 테스트 기기(Android)에서 Google Play 스토어 앱을 엽니다.
2. 테스트 계정으로 로그인합니다 (라이선스 테스트에 추가한 계정).
3. Google Play 스토어에서 앱을 다운로드하거나, 개발자 빌드를 설치합니다.

### 3. 테스트 결제 확인
- 테스트 계정으로 구매하면 실제 결제가 발생하지 않습니다.
- 구매 영수증에는 "테스트 구매"라는 레이블이 표시됩니다.
- Google Play Console의 **주문 관리**에서 테스트 주문을 확인할 수 있습니다.

---

## 앱 빌드 및 테스트

### 1. 앱 빌드
```bash
# 개발 빌드 (테스트용)
npm run build:android

# 또는 릴리스 빌드
npm run build:android:release
```

### 2. 앱 설치
- 내부 테스트 트랙을 통해 배포하거나
- 직접 APK를 설치합니다:
  ```bash
  adb install android/app/build/outputs/apk/debug/app-debug.apk
  ```

### 3. 인앱결제 테스트
1. 앱을 실행합니다.
2. 테스트 계정으로 로그인합니다.
3. 포인트 충전 또는 구독 페이지로 이동합니다.
4. 상품을 선택하고 구매를 진행합니다.
5. Google Play 결제 화면이 나타나면:
   - 테스트 결제이므로 실제 결제가 발생하지 않습니다.
   - "테스트 구매"라는 메시지가 표시됩니다.
6. 구매가 완료되면 앱에서 상품이 지급되는지 확인합니다.

---

## 문제 해결

### 문제 1: 상품 정보가 조회되지 않음
**원인**: 
- 제품 ID가 일치하지 않음
- 상품이 아직 활성화되지 않음
- 앱이 내부 테스트 트랙 이상으로 배포되지 않음

**해결 방법**:
1. Google Play Console에서 제품 ID가 정확한지 확인
2. 상품이 활성화되었는지 확인
3. 앱이 최소한 내부 테스트 트랙으로 배포되었는지 확인
4. 상품 활성화 후 몇 시간 기다린 후 다시 시도

### 문제 2: 결제 화면이 나타나지 않음
**원인**:
- Billing 플러그인이 제대로 설치되지 않음
- Android 빌드에 플러그인이 포함되지 않음

**해결 방법**:
1. 플러그인 설치 확인:
   ```bash
   npm list @capacitor-community/billing
   ```
2. Capacitor 동기화:
   ```bash
   npx cap sync android
   ```
3. 앱을 다시 빌드하고 설치

### 문제 3: 실제 결제가 발생함
**원인**:
- 테스트 계정으로 로그인하지 않음
- 라이선스 테스트 계정이 제대로 설정되지 않음

**해결 방법**:
1. Google Play Console에서 라이선스 테스트 계정이 올바르게 추가되었는지 확인
2. 테스트 기기에서 올바른 계정으로 Google Play 스토어에 로그인했는지 확인
3. 앱을 완전히 삭제하고 다시 설치

### 문제 4: 구독 상태가 확인되지 않음
**원인**:
- 구독 구매 확인(acknowledge)이 되지 않음
- 구독 조회 API 호출 오류

**해결 방법**:
1. 앱 로그에서 오류 메시지 확인
2. 구매 후 acknowledge가 제대로 호출되는지 확인
3. 구독 상품의 제품 ID가 정확한지 확인

---

## 테스트 체크리스트

테스트 시 다음 항목들을 확인하세요:

### 일회성 상품
- [ ] 상품 목록이 정상적으로 로드되는가?
- [ ] 상품 가격이 올바르게 표시되는가?
- [ ] 구매 프로세스가 정상적으로 진행되는가?
- [ ] 구매 후 상품이 정상적으로 지급되는가?
- [ ] 구매 내역이 Firebase에 저장되는가?
- [ ] 중복 구매가 방지되는가?

### 정기 구독
- [ ] 구독 목록이 정상적으로 로드되는가?
- [ ] 구독 가격이 올바르게 표시되는가?
- [ ] 구독 구매 프로세스가 정상적으로 진행되는가?
- [ ] 구독 상태가 정상적으로 확인되는가?
- [ ] 구독 취소가 정상적으로 작동하는가?
- [ ] 구독 갱신이 정상적으로 작동하는가?

---

## 추가 정보

### 유용한 명령어

```bash
# 플러그인 설치
npm install @capacitor-community/billing

# Android 동기화
npx cap sync android

# Android 빌드
npm run build:android

# Android Studio에서 열기
npx cap open android
```

### 참고 링크
- [Google Play Billing Library 문서](https://developer.android.com/google/play/billing)
- [Google Play Console 도움말](https://support.google.com/googleplay/android-developer)
- [Capacitor Billing 플러그인 문서](https://github.com/capacitor-community/billing)

---

## 플러그인 호환성 문제

만약 `@capacitor-community/billing` 플러그인이 Capacitor 7과 호환되지 않는 경우, 다음 방법을 고려할 수 있습니다:

1. **네이티브 코드 직접 구현**: Google Play Billing Library를 직접 사용
2. **다른 플러그인 사용**: 다른 인앱결제 플러그인 검토
3. **플러그인 포크/수정**: 필요한 경우 플러그인을 포크하여 수정

필요한 경우 추가 지원을 요청하세요.

---

**작성일**: 2024년
**최종 업데이트**: 2024년


